# v0.2 "Steady Tracking" â€” Implementation Plan

> Position calculations and solar system awareness

## Overview

v0.2 adds solar and lunar ephemerides, observer management, and visibility calculations. This transforms astr0 from a coordinate/time converter into a practical observing tool.

---

## New Modules Required

### 1. `sun` Module â€” Solar Position & Events

**File**: `src/astr0/core/sun.py`

| Function | Description | Algorithm |
|----------|-------------|-----------|
| `sun_position(jd)` | RA/Dec of the Sun | Low-precision solar coordinates |
| `sun_ecliptic(jd)` | Ecliptic longitude/latitude | Meeus Ch. 25 |
| `equation_of_time(jd)` | Difference between apparent and mean solar time | |
| `sunrise(jd, lat, lon)` | Sunrise time | Meeus Ch. 15 |
| `sunset(jd, lat, lon)` | Sunset time | Meeus Ch. 15 |
| `solar_noon(jd, lon)` | Local solar noon | |
| `twilight_civil(jd, lat, lon)` | Sun at -6Â° | |
| `twilight_nautical(jd, lat, lon)` | Sun at -12Â° | |
| `twilight_astronomical(jd, lat, lon)` | Sun at -18Â° | |
| `day_length(jd, lat, lon)` | Hours of daylight | |
| `solar_altitude(jd, lat, lon)` | Current solar altitude | |

**CLI Commands**:
```bash
astr0 sun position                    # Current solar position
astr0 sun rise --lat 34.05 --lon -118.25  # Today's sunrise
astr0 sun set --lat 34.05 --lon -118.25   # Today's sunset
astr0 sun twilight --lat 34.05 --lon -118.25  # All twilight times
astr0 sun altitude --lat 34.05 --lon -118.25  # Current solar altitude
```

---

### 2. `moon` Module â€” Lunar Position & Phases

**File**: `src/astr0/core/moon.py`

| Function | Description | Algorithm |
|----------|-------------|-----------|
| `moon_position(jd)` | RA/Dec of the Moon | Low-precision lunar coords |
| `moon_phase(jd)` | Phase angle (0-360Â°) | |
| `moon_illumination(jd)` | Illuminated fraction (0-1) | |
| `moon_phase_name(jd)` | "New", "First Quarter", etc. | |
| `moonrise(jd, lat, lon)` | Moonrise time | |
| `moonset(jd, lat, lon)` | Moonset time | |
| `next_phase(jd, phase)` | Next new/full/quarter moon | |
| `lunar_age(jd)` | Days since new moon | |
| `moon_distance(jd)` | Earth-Moon distance (km) | |

**CLI Commands**:
```bash
astr0 moon position                   # Current lunar position
astr0 moon phase                      # Current phase and illumination
astr0 moon rise --lat 34.05 --lon -118.25  # Tonight's moonrise
astr0 moon calendar 2026 01           # Moon phases for month
```

---

### 3. `observer` Module â€” Observer Management

**File**: `src/astr0/core/observer.py`

| Class/Function | Description |
|----------------|-------------|
| `Observer` | Dataclass: name, latitude, longitude, elevation, timezone |
| `load_observers()` | Load from ~/.astr0/observers.toml |
| `save_observer(obs)` | Save to config file |
| `get_observer(name)` | Retrieve by name |
| `default_observer()` | Get/set default observer |

**Config File**: `~/.astr0/observers.toml`
```toml
default = "home"

[observers.home]
name = "Home"
latitude = 34.0522
longitude = -118.2437
elevation = 71
timezone = "America/Los_Angeles"

[observers.palomar]
name = "Palomar Observatory"
latitude = 33.3563
longitude = -116.8650
elevation = 1712
timezone = "America/Los_Angeles"
```

**CLI Commands**:
```bash
astr0 observer add "Home" --lat 34.05 --lon -118.25 --elev 71
astr0 observer list
astr0 observer default home
astr0 observer show home
astr0 observer remove home
```

---

### 4. `visibility` Module â€” Object Visibility

**File**: `src/astr0/core/visibility.py`

| Function | Description |
|----------|-------------|
| `is_visible(coord, observer, jd)` | Is object above horizon? |
| `altitude_at(coord, observer, jd)` | Altitude at given time |
| `rise_time(coord, observer, jd)` | When object rises |
| `set_time(coord, observer, jd)` | When object sets |
| `transit_time(coord, observer, jd)` | When object transits meridian |
| `transit_altitude(coord, observer)` | Maximum altitude |
| `hours_visible(coord, observer, jd)` | Hours above horizon tonight |
| `best_time(coord, observer, jd)` | Optimal viewing window |
| `darkness_window(observer, jd)` | Astronomical darkness times |

**CLI Commands**:
```bash
astr0 visibility "12h30m +45d"        # Is it visible now?
astr0 visibility "12h30m +45d" --when # Rise/transit/set times
astr0 visibility "12h30m +45d" --tonight  # Tonight's visibility window
astr0 tonight --observer home         # What's visible tonight
```

---

## Enhancements

### LaTeX Output Formatter

**File**: `src/astr0/output/formatters.py` (extend)

Add `LatexFormatter` class:
```python
class LatexFormatter(Formatter):
    """Format output as LaTeX for publication/documentation."""
    
    def format_angle(self, angle: Angle) -> str:
        return f"${angle.degrees:.6f}^\\circ$"
    
    def format_coordinate(self, coord: ICRSCoord) -> str:
        return f"$\\alpha = {coord.ra.to_hms()}$, $\\delta = {coord.dec.to_dms()}$"
    
    def format_verbose_steps(self, steps: list) -> str:
        # Format as align environment with equations
        ...
```

**CLI**: `astr0 --output latex ...`

---

### Observer-Aware Commands

Update existing commands to accept `--observer`:
```bash
astr0 coords transform "12h +45d" --to altaz --observer home
astr0 time lst --observer home
```

---

## File Structure

```
src/astr0/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ sun.py          # NEW
â”‚   â”œâ”€â”€ moon.py         # NEW
â”‚   â”œâ”€â”€ observer.py     # NEW
â”‚   â”œâ”€â”€ visibility.py   # NEW
â”‚   â”œâ”€â”€ time.py         # (existing)
â”‚   â”œâ”€â”€ coords.py       # (existing)
â”‚   â”œâ”€â”€ angles.py       # (existing)
â”‚   â””â”€â”€ constants.py    # (add solar/lunar constants)
â”œâ”€â”€ cli/
â”‚   â”œâ”€â”€ sun_cmd.py      # NEW
â”‚   â”œâ”€â”€ moon_cmd.py     # NEW
â”‚   â”œâ”€â”€ observer_cmd.py # NEW
â”‚   â”œâ”€â”€ visibility_cmd.py # NEW
â”‚   â””â”€â”€ __init__.py     # (register new commands)
â””â”€â”€ output/
    â””â”€â”€ formatters.py   # (add LaTeX formatter)
```

---

## Implementation Order

### Phase 1: Foundation
1. [ ] Add solar/lunar constants to `constants.py`
2. [ ] Create `Observer` dataclass and config file handling
3. [ ] Add `--observer` flag to CLI infrastructure

### Phase 2: Sun Module
4. [ ] Implement `sun.py` core functions
5. [ ] Create `sun_cmd.py` CLI commands
6. [ ] Write tests for sun module
7. [ ] Add sun documentation

### Phase 3: Moon Module
8. [ ] Implement `moon.py` core functions
9. [ ] Create `moon_cmd.py` CLI commands
10. [ ] Write tests for moon module
11. [ ] Add moon documentation

### Phase 4: Visibility
12. [ ] Implement rise/set/transit calculations
13. [ ] Create `visibility.py` module
14. [ ] Create `visibility_cmd.py` CLI commands
15. [ ] Write visibility tests
16. [ ] Add visibility documentation

### Phase 5: Enhancements
17. [ ] Implement LaTeX formatter
18. [ ] Update existing commands for observer support
19. [ ] Integration testing
20. [ ] Update ROADMAP.md to mark v0.2 complete

---

## Test Requirements

Each module needs:
- Unit tests for core calculations
- Validation against authoritative sources (USNO, JPL Horizons)
- Property-based tests with Hypothesis
- CLI integration tests

**Validation Sources**:
- Sun/Moon positions: JPL Horizons, USNO
- Rise/set times: timeanddate.com, USNO calculator
- Moon phases: NASA Moon Phase Calculator

---

## Dependencies

No new external dependencies required. All algorithms implemented from:
- Meeus, J. "Astronomical Algorithms" (primary reference)
- Explanatory Supplement to the Astronomical Almanac

---

## Documentation Updates

- [ ] `docs/sun.md` â€” Solar calculations guide
- [ ] `docs/moon.md` â€” Lunar calculations guide  
- [ ] `docs/observer.md` â€” Observer management guide
- [ ] `docs/visibility.md` â€” Visibility planning guide
- [ ] Update `docs/index.md` with new modules
- [ ] Update `docs/cli-reference.md` with new commands

---

## Estimated Effort

| Component | Estimate |
|-----------|----------|
| Sun module | 4-6 hours |
| Moon module | 4-6 hours |
| Observer module | 2-3 hours |
| Visibility module | 4-6 hours |
| LaTeX formatter | 2-3 hours |
| Tests | 4-6 hours |
| Documentation | 3-4 hours |
| **Total** | **23-34 hours** |

---

*Let's bring the Sun and Moon into astr0!* â˜€ï¸ğŸŒ™
